<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Upgrade Configurator | AutoGaard Workshop</title>
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary)', 'primary-dark': 'var(--primary-dark)', 'bg-body': 'var(--bg-body)',
                        'bg-surface': 'var(--bg-surface)', 'bg-surface-elevated': 'var(--bg-surface-elevated)',
                        'text-primary': 'var(--text-primary)', 'text-secondary': 'var(--text-secondary)', 'border-color': 'var(--border-color)',
                    },
                    fontFamily: { bebas: ['Bebas Neue', 'sans-serif'], display: ['Rajdhani', 'sans-serif'], body: ['Inter', 'sans-serif'], }
                }
            }
        }
    </script>
    <style>
        html,
        body {
            background-color: var(--bg-body) !important;
            margin: 0;
            padding: 0;
        }

        .page-wrapper {
            background-color: var(--bg-body);
        }

        .upgrade-option {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            cursor: pointer;
        }

        .upgrade-option.selected {
            border-color: var(--primary);
            background: var(--primary)/5;
        }

        .option-check {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 0.5rem;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upgrade-option.selected .option-check {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
    </style>
    <script src="../js/theme.js"></script>
    <script src="js/garage-data.js"></script>
    <script src="js/registration-services.js"></script>
</head>

<body class="bg-bg-body text-text-primary">
    <div class="page-wrapper container pb-32">
        <header class="app-header">
            <button onclick="window.history.back()" class="p-2 -ml-2"><span
                    class="material-symbols-outlined text-text-primary">arrow_back</span></button>
            <h1 class="header-title uppercase tracking-widest">Upgrade Config</h1>
            <button onclick="showAIPreview()" class="p-2 -mr-2 text-primary"><span
                    class="material-symbols-outlined">auto_awesome</span></button>
        </header>

        <main class="animate-fade-in px-gutter">
            <!-- VEHICLE CONTEXT -->
            <div id="vehicle-card" class="mb-6 mt-4"></div>

            <!-- INTELLIGENT FACELIFT SECTION -->
            <div id="facelift-section" class="mb-8 hidden">
                <div class="flex items-center justify-between mb-4 px-1">
                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-primary">Model Facelift Available
                    </p>
                    <span class="px-2 py-0.5 bg-primary/20 text-primary rounded-lg text-xs font-bold">New</span>
                </div>
                <div id="facelift-container"></div>
            </div>

            <!-- UPGRADE CATEGORIES -->
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-text-secondary/60 mb-4 px-1">Custom
                Upgrades</p>

            <div class="flex gap-2 mb-6 overflow-x-auto no-scrollbar">
                <button onclick="switchCategory('exterior')" id="tab-exterior"
                    class="px-4 py-2 bg-primary text-white rounded-xl text-[9px] font-black uppercase tracking-widest whitespace-nowrap">Exterior</button>
                <button onclick="switchCategory('interior')" id="tab-interior"
                    class="px-4 py-2 bg-bg-surface border border-border-color rounded-xl text-[9px] font-black uppercase tracking-widest whitespace-nowrap">Interior</button>
                <button onclick="switchCategory('tech')" id="tab-tech"
                    class="px-4 py-2 bg-bg-surface border border-border-color rounded-xl text-[9px] font-black uppercase tracking-widest whitespace-nowrap">Tech
                    / Sound</button>
            </div>

            <div id="upgrades-container" class="space-y-4">
                <!-- Populated by JS -->
            </div>

            <!-- SUMMARY STICKY -->
            <div
                class="fixed bottom-0 left-0 right-0 p-6 bg-bg-body/80 backdrop-blur-xl border-t border-white/5 z-50 max-w-md mx-auto">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-[8px] font-black uppercase tracking-widest text-text-secondary">Estimated Total
                        </p>
                        <p class="text-2xl font-bold text-primary" id="total-cost">₦0</p>
                    </div>
                    <button onclick="generateProposal()"
                        class="px-8 py-4 bg-primary text-white rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-primary/20">Generate
                        Invoice</button>
                </div>
            </div>
        </main>
    </div>

    <!-- AI PREVIEW MODAL -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-6">
        <div class="bg-bg-surface rounded-3xl w-full overflow-hidden border border-white/10">
            <div class="p-6 border-b border-white/5 flex justify-between">
                <h3 class="font-[var(--font-bebas)] text-xl tracking-widest uppercase">AI Transformation Preview</h3>
                <button onclick="closeAIModal()"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="p-8 text-center">
                <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="material-symbols-outlined text-4xl text-primary animate-pulse">auto_awesome</span>
                </div>
                <h4 class="text-sm font-bold mb-2">Generating Configured Vision</h4>
                <p class="text-[10px] text-text-secondary uppercase tracking-widest leading-relaxed">Our AI is
                    processing your specific year upgrade and aesthetic changes. This will be ready in 30 seconds.</p>
                <div class="mt-8 bg-bg-body rounded-2xl h-1.5 overflow-hidden">
                    <div class="bg-primary h-full w-[45%] animate-pulse"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const upgradeMapping = {
            'TOYOTA': {
                'CAMRY': [
                    { from: [2007, 2008, 2009, 2010], to: 2011, label: 'LE/XLE Facelift Kit', price: 650000, desc: 'Update bumpers, grille, and light assembly to 2011 specs.' },
                    { from: [2012, 2013, 2014], to: 2017, label: 'SE Sport Facelift Kit', price: 850000, desc: 'Full 2017 high-trim conversion including LED DRLs.' }
                ],
                'COROLLA': [
                    { from: [2003, 2004, 2005, 2006], to: 2008, label: 'Modern Facelift Kit', price: 420000, desc: 'Updated aesthetics to 2008 design standards.' }
                ]
            },
            'HONDA': {
                'ACCORD': [
                    { from: [2013, 2014, 2015], to: 2017, label: 'Modern LED Facelift', price: 950000, desc: 'Signature 2017 LED headlight and grille conversion.' }
                ]
            },
            'LEXUS': {
                'ES350': [
                    { from: [2007, 2008, 2009], to: 2012, label: 'F-Sport Style Facelift', price: 750000, desc: 'Modernized spindle-style grille and LED indicators.' }
                ],
                'GX460': [
                    { from: [2010, 2011, 2012, 2013], to: 2021, label: 'Spindle Grille Conversion', price: 1850000, desc: 'Massive 2021 spindle grille conversion & triple-beam LEDs.' }
                ]
            }
        };

        const upgrades = {
            exterior: [
                { name: 'Forged Alloy Wheels - 19"', price: 550000, beauty: 2, perf: 1, tech: 0 },
                { name: 'Matte Vinyl Wrap', price: 320000, beauty: 3, perf: 0, tech: 0 },
                { name: 'Carbon Fiber Mirror Caps', price: 85000, beauty: 1, perf: 0, tech: 0 },
                { name: 'Ceramic Window Tint', price: 120000, beauty: 1, perf: 0, tech: 0 }
            ],
            interior: [
                { name: 'Nappa Leather Interior', price: 680000, beauty: 3, perf: 0, tech: 0 },
                { name: 'Starlight Headliner', price: 250000, beauty: 3, perf: 0, tech: 0 },
                { name: 'Carbon Fiber Trim Kit', price: 180000, beauty: 2, perf: 0, tech: 0 },
                { name: 'Ambient Lighting (64-Color)', price: 95000, beauty: 2, perf: 0, tech: 1 }
            ],
            tech: [
                { name: 'Android 14 Infotainment', price: 280000, beauty: 1, perf: 0, tech: 3 },
                { name: 'Focal Surround System', price: 450000, beauty: 0, perf: 0, tech: 3 },
                { name: '360° Bird-Eye Camera', price: 320000, beauty: 0, perf: 0, tech: 3 },
                { name: 'Smart Soft-Close Doors', price: 250000, beauty: 1, perf: 0, tech: 2 }
            ]
        };

        let activeVehicle = null;
        let selectedUpgrades = new Set();
        let currentTab = 'exterior';

        function init() {
            activeVehicle = GarageData.getActiveVehicle();
            if (!activeVehicle) {
                window.location.href = 'select-vehicle.html?service=upgrade';
                return;
            }
            RegistrationServices.renderVehicleCard(activeVehicle, 'vehicle-card');
            checkFaceliftOptions();
            renderUpgrades();
        }

        function checkFaceliftOptions() {
            const make = activeVehicle.make.toUpperCase();
            const model = activeVehicle.model.toUpperCase();
            const year = activeVehicle.year;

            const makeGroup = upgradeMapping[make];
            if (makeGroup && makeGroup[model]) {
                const option = makeGroup[model].find(o => o.from.includes(year));
                if (option) {
                    const container = document.getElementById('facelift-container');
                    container.innerHTML = `
                        <div class="upgrade-option rounded-3xl p-5 border-primary/30 bg-primary/5 flex items-start gap-4" onclick="toggleUpgrade(this, '${option.label}', ${option.price})">
                            <div class="icon-box w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined">auto_awesome</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-1">
                                    <h3 class="text-sm font-bold tracking-widest uppercase">${option.label}</h3>
                                    <span class="text-sm font-bold text-primary">${GarageData.formatCurrency(option.price)}</span>
                                </div>
                                <p class="text-[9px] text-text-secondary uppercase tracking-widest leading-relaxed mb-3">${option.desc}</p>
                                <div class="flex gap-2">
                                    <span class="px-2 py-0.5 bg-green-500/10 text-green-500 rounded-lg text-[7px] font-bold uppercase">Upgrade to ${option.to} Look</span>
                                    <span class="px-2 py-0.5 bg-blue-500/10 text-blue-500 rounded-lg text-[7px] font-bold uppercase">+25% Value Impact</span>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('facelift-section').classList.remove('hidden');
                }
            }
        }

        function switchCategory(cat) {
            currentTab = cat;
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-bg-surface', 'border', 'border-border-color');
            });
            document.getElementById('tab-' + cat).classList.remove('bg-bg-surface', 'border', 'border-border-color');
            document.getElementById('tab-' + cat).classList.add('bg-primary', 'text-white');
            renderUpgrades();
        }

        function renderUpgrades() {
            const container = document.getElementById('upgrades-container');
            const items = upgrades[currentTab];
            container.innerHTML = items.map(item => `
                <div class="upgrade-option rounded-3xl p-5 flex items-center gap-4 ${selectedUpgrades.has(item.name) ? 'selected' : ''}" onclick="toggleUpgrade(this, '${item.name}', ${item.price})">
                    <div class="option-check flex-shrink-0">
                        <span class="material-symbols-outlined text-xs">check</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <h3 class="text-sm font-bold tracking-widest uppercase">${item.name}</h3>
                            <span class="text-sm font-bold text-primary">${GarageData.formatCurrency(item.price)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleUpgrade(el, name, price) {
            if (selectedUpgrades.has(name)) {
                selectedUpgrades.delete(name);
                el.classList.remove('selected');
            } else {
                selectedUpgrades.add(name);
                el.classList.add('selected');
            }
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            // Scan all available upgrade prices
            const allPossible = [...upgrades.exterior, ...upgrades.interior, ...upgrades.tech];
            // Add facelift if selected
            const faceliftOption = document.querySelector('#facelift-section .upgrade-option.selected');
            if (faceliftOption) {
                // price is passed via onclick, hard to extract easily without mapping search
            }
            // Better way: track selected prices in an array or map
            // For now, let's just calculate based on names
            selectedUpgrades.forEach(name => {
                const item = allPossible.find(u => u.name === name);
                if (item) total += item.price;
                // Check facelift mapping too
                const makeGroup = upgradeMapping[activeVehicle.make.toUpperCase()];
                if (makeGroup && makeGroup[activeVehicle.model.toUpperCase()]) {
                    const fo = makeGroup[activeVehicle.model.toUpperCase()].find(o => o.label === name);
                    if (fo) total += fo.price;
                }
            });

            document.getElementById('total-cost').textContent = GarageData.formatCurrency(total);
        }

        function showAIPreview() {
            document.getElementById('ai-modal').classList.remove('hidden');
        }

        function closeAIModal() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        function generateProposal() {
            if (selectedUpgrades.size === 0) {
                alert('Please select at least one upgrade');
                return;
            }
            // Store selected in local storage for proposal
            localStorage.setItem('pending_upgrades', JSON.stringify(Array.from(selectedUpgrades)));
            window.location.href = `security-tech-review.html?type=upgrade`; // Reusing a review template
        }

        init();
    </script>
</body>

</html>
