<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vehicle License Renewal | AutoGaard Workshop</title>

    <!-- CSS SYSTEM -->
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">

    <!-- Tailwind CDN + Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary)',
                        'primary-dark': 'var(--primary-dark)',
                        'bg-body': 'var(--bg-body)',
                        'bg-surface': 'var(--bg-surface)',
                        'bg-surface-elevated': 'var(--bg-surface-elevated)',
                        'text-primary': 'var(--text-primary)',
                        'text-secondary': 'var(--text-secondary)',
                        'border-color': 'var(--border-color)',
                    },
                    fontFamily: {
                        bebas: ['Bebas Neue', 'sans-serif'],
                        display: ['Rajdhani', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="../js/theme.js"></script>
    <script src="js/garage-data.js"></script>
    <script src="js/registration-services.js"></script>

    <style>
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-surface);
            border: 1px solid var(--primary);
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* Fix for red screen background bleed */
        html,
        body {
            background-color: var(--bg-body) !important;
            margin: 0;
            padding: 0;
        }

        .page-wrapper {
            background-color: var(--bg-body);
        }
    </style>
</head>

<body class="bg-bg-body text-text-primary">

    <div class="page-wrapper container pb-32">

        <!-- HEADER -->
        <header class="app-header">
            <button onclick="window.history.back()" class="p-2 -ml-2">
                <span class="material-symbols-outlined text-text-primary">arrow_back</span>
            </button>
            <h1 class="header-title uppercase tracking-widest">License Renewal</h1>
            <div class="w-10"></div>
        </header>

        <main class="animate-fade-in px-gutter">

            <!-- PROGRESS INDICATOR -->
            <div class="flex items-center justify-center gap-2 mb-6 mt-4">
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-xs font-bold">
                        1
                    </div>
                    <span class="text-[9px] uppercase tracking-widest text-primary font-bold">Configure</span>
                </div>
                <div class="w-12 h-0.5 bg-border-color"></div>
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-full bg-border-color text-text-secondary flex items-center justify-center text-xs font-bold">
                        2
                    </div>
                    <span class="text-[9px] uppercase tracking-widest text-text-secondary">Review</span>
                </div>
                <div class="w-12 h-0.5 bg-border-color"></div>
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-full bg-border-color text-text-secondary flex items-center justify-center text-xs font-bold">
                        3
                    </div>
                    <span class="text-[9px] uppercase tracking-widest text-text-secondary">Submit</span>
                </div>
            </div>

            <!-- VEHICLE CARD -->
            <div class="bg-gradient-to-br from-primary/10 to-primary/5 border border-primary/20 rounded-2xl p-5 mb-6"
                id="vehicle-card">
                <!-- Populated by JavaScript -->
            </div>

            <!-- CURRENT LICENSE INFO -->
            <div class="bg-bg-surface border border-border-color rounded-2xl p-5 mb-6">
                <h3 class="text-sm font-black uppercase tracking-widest mb-4">Current License Information</h3>

                <div class="space-y-3">
                    <div>
                        <label
                            class="text-[8px] font-black uppercase tracking-widest text-text-secondary block mb-1">License
                            Number</label>
                        <input type="text" id="license-number" placeholder="e.g., LAG-2023-ABC123"
                            class="w-full bg-bg-body border border-border-color rounded-xl p-3 text-sm">
                    </div>

                    <div>
                        <label
                            class="text-[8px] font-black uppercase tracking-widest text-text-secondary block mb-1">Expiry
                            Date</label>
                        <input type="date" id="expiry-date"
                            class="w-full bg-bg-body border border-border-color rounded-xl p-3 text-sm">
                    </div>

                    <div>
                        <label
                            class="text-[8px] font-black uppercase tracking-widest text-text-secondary block mb-1">Vehicle
                            Category</label>
                        <select id="vehicle-category"
                            class="w-full bg-bg-body border border-border-color rounded-xl p-3 text-sm">
                            <option value="private">Private</option>
                            <option value="commercial">Commercial</option>
                            <option value="government">Government</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- STATE SELECTION -->
            <div class="bg-bg-surface border border-border-color rounded-2xl p-5 mb-6">
                <h3 class="text-sm font-black uppercase tracking-widest mb-4">State of Registration</h3>
                <div id="state-selector">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- FINES CHECK -->
            <div class="bg-bg-surface border border-border-color rounded-2xl p-5 mb-6">
                <h3 class="text-sm font-black uppercase tracking-widest mb-4">Fines Check & Clearance</h3>

                <label class="flex items-start gap-3 cursor-pointer mb-3">
                    <input type="checkbox" id="check-fines" checked class="mt-1">
                    <div class="flex-1">
                        <p class="text-sm font-bold">Check for Outstanding Fines</p>
                        <p class="text-xs text-text-secondary">We'll check FRSC, LASTMA, and VIS databases</p>
                    </div>
                </label>

                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="clear-fines" checked class="mt-1">
                    <div class="flex-1">
                        <p class="text-sm font-bold">Clear Fines (if found)</p>
                        <p class="text-xs text-text-secondary">We'll clear any outstanding fines on your behalf</p>
                    </div>
                </label>
            </div>

            <!-- DELIVERY METHOD -->
            <div class="bg-bg-surface border border-border-color rounded-2xl p-5 mb-6">
                <h3 class="text-sm font-black uppercase tracking-widest mb-4">Delivery Method</h3>

                <label
                    class="flex items-center gap-3 p-3 border-2 border-border-color rounded-xl mb-3 cursor-pointer hover:border-primary transition-all">
                    <input type="radio" name="delivery" value="pickup" checked onchange="updatePricing()">
                    <div class="flex-1">
                        <p class="text-sm font-bold">Pickup at MVAA Office</p>
                        <p class="text-xs text-text-secondary">Collect from processing location</p>
                    </div>
                    <span class="text-primary font-bold">Free</span>
                </label>

                <label
                    class="flex items-center gap-3 p-3 border-2 border-border-color rounded-xl cursor-pointer hover:border-primary transition-all">
                    <input type="radio" name="delivery" value="home-delivery" onchange="updatePricing()">
                    <div class="flex-1">
                        <p class="text-sm font-bold">Home Delivery</p>
                        <p class="text-xs text-text-secondary">We'll deliver to your address</p>
                    </div>
                    <span class="text-primary font-bold">+â‚¦5,000</span>
                </label>

                <div id="delivery-address-section" style="display: none;" class="mt-3">
                    <label
                        class="text-[8px] font-black uppercase tracking-widest text-text-secondary block mb-1">Delivery
                        Address</label>
                    <textarea id="delivery-address" rows="2" placeholder="Enter your delivery address"
                        class="w-full bg-bg-body border border-border-color rounded-xl p-3 text-sm resize-none"></textarea>
                </div>
            </div>

            <!-- DOCUMENT UPLOAD -->
            <div class="bg-bg-surface border border-border-color rounded-2xl p-5 mb-6" id="document-upload">
                <!-- Populated by JavaScript -->
            </div>

            <!-- PRICING ESTIMATE -->
            <div class="bg-gradient-to-br from-primary/10 to-primary/5 border border-primary/20 rounded-2xl p-5 mb-6"
                id="pricing-breakdown">
                <!-- Populated by JavaScript -->
            </div>

            <!-- ACTION BUTTON -->
            <button onclick="proceedToReview()" id="proceed-btn"
                class="w-full py-4 bg-primary text-white rounded-xl text-sm font-black uppercase tracking-widest shadow-lg shadow-primary/20 hover:bg-primary-dark transition-all">
                Proceed to Review
            </button>

        </main>

        <!-- BOTTOM NAVIGATION -->
        <nav class="bottom-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="material-symbols-outlined">grid_view</span>
                <span class="nav-label">Home</span>
            </a>
            <a href="../fleet.html" class="nav-item">
                <span class="material-symbols-outlined">explore</span>
                <span class="nav-label">Fleet</span>
            </a>
            <a href="../garage.html" class="nav-item active">
                <span class="material-symbols-outlined">directions_car</span>
                <span class="nav-label">Garage</span>
            </a>
            <a href="../inquiries.html" class="nav-item">
                <span class="material-symbols-outlined">forum</span>
                <span class="nav-label">Concierge</span>
            </a>
            <a href="../settings.html" class="nav-item">
                <span class="material-symbols-outlined">tune</span>
                <span class="nav-label">Settings</span>
            </a>
        </nav>
    </div>

    <script>
        let activeVehicle = null;

        // Initialize
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const vid = urlParams.get('vid') || GarageData.getActiveVehicle()?.id;

            activeVehicle = GarageData.getVehicleById(vid);

            if (!activeVehicle) {
                window.location.href = 'select-vehicle.html?service=vehicle-license-renewal';
                return;
            }

            // Render components
            RegistrationServices.renderVehicleCard(activeVehicle, 'vehicle-card');
            RegistrationServices.renderStateSelector('state-selector', 'lagos');
            RegistrationServices.renderDocumentUpload('document-upload', ['vehicle-license', 'owner-id']);

            // Setup delivery method listener
            document.querySelectorAll('input[name="delivery"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const addressSection = document.getElementById('delivery-address-section');
                    if (e.target.value === 'home-delivery') {
                        addressSection.style.display = 'block';
                    } else {
                        addressSection.style.display = 'none';
                    }
                });
            });

            // Load saved progress
            loadProgress();

            // Initial pricing
            updatePricing();

            // Auto-save on input
            document.addEventListener('input', saveProgress);
            document.addEventListener('change', saveProgress);
        }

        function updatePricing() {
            const state = document.getElementById('state-select')?.value || 'lagos';
            const stateData = RegistrationServices.STATES[state];
            const deliveryMethod = document.querySelector('input[name="delivery"]:checked')?.value || 'pickup';

            const fees = {
                governmentFees: stateData.fees.vehicleLicense,
                serviceFee: 15000,
                finesClearance: 0, // Will be determined after fines check
                deliveryFee: deliveryMethod === 'home-delivery' ? 5000 : 0,
                total: 0
            };

            fees.total = fees.governmentFees + fees.serviceFee + fees.finesClearance + fees.deliveryFee;

            RegistrationServices.renderFeeBreakdown('pricing-breakdown', fees);
        }

        function saveProgress() {
            const config = {
                vehicleId: activeVehicle.id,
                licenseNumber: document.getElementById('license-number')?.value || '',
                expiryDate: document.getElementById('expiry-date')?.value || '',
                vehicleCategory: document.getElementById('vehicle-category')?.value || 'private',
                state: document.getElementById('state-select')?.value || 'lagos',
                checkFines: document.getElementById('check-fines')?.checked || false,
                clearFines: document.getElementById('clear-fines')?.checked || false,
                deliveryMethod: document.querySelector('input[name="delivery"]:checked')?.value || 'pickup',
                deliveryAddress: document.getElementById('delivery-address')?.value || ''
            };

            RegistrationServices.saveProgress('vehicle-license-renewal', config);
        }

        function loadProgress() {
            const saved = RegistrationServices.loadProgress('vehicle-license-renewal');
            if (!saved) return;

            if (saved.licenseNumber) document.getElementById('license-number').value = saved.licenseNumber;
            if (saved.expiryDate) document.getElementById('expiry-date').value = saved.expiryDate;
            if (saved.vehicleCategory) document.getElementById('vehicle-category').value = saved.vehicleCategory;
            if (saved.state) document.getElementById('state-select').value = saved.state;
            if (saved.checkFines !== undefined) document.getElementById('check-fines').checked = saved.checkFines;
            if (saved.clearFines !== undefined) document.getElementById('clear-fines').checked = saved.clearFines;

            if (saved.deliveryMethod) {
                const radio = document.querySelector(`input[name="delivery"][value="${saved.deliveryMethod}"]`);
                if (radio) {
                    radio.checked = true;
                    if (saved.deliveryMethod === 'home-delivery') {
                        document.getElementById('delivery-address-section').style.display = 'block';
                        if (saved.deliveryAddress) {
                            document.getElementById('delivery-address').value = saved.deliveryAddress;
                        }
                    }
                }
            }

            updatePricing();
        }

        function proceedToReview() {
            // Validate required fields
            const licenseNumber = document.getElementById('license-number').value;
            const expiryDate = document.getElementById('expiry-date').value;

            if (!licenseNumber || !expiryDate) {
                RegistrationServices.showToast('Please fill in all required fields', 'error');
                return;
            }

            // Validate documents
            const validation = RegistrationServices.validateDocuments(['vehicle-license', 'owner-id']);
            if (!validation.valid) {
                RegistrationServices.showToast(`Missing documents: ${validation.missing.join(', ')}`, 'error');
                return;
            }

            // Save final configuration
            saveProgress();

            // Navigate to review
            window.location.href = `license-renewal-review.html?vid=${activeVehicle.id}`;
        }

        // Initialize on load
        init();
    </script>
</body>

</html>
